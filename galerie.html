<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galerie</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Specific gallery tweaks */
        .filters{display:flex;gap:0.6rem;flex-wrap:wrap;justify-content:center;margin:2rem 0}
        .filters button{background:transparent;border:2px solid rgba(255,255,255,0.08);padding:0.5rem 0.9rem;border-radius:8px;color:var(--choco-900);font-weight:600;cursor:pointer}
        .filters button.active{background:var(--choco-700);color:var(--cream-200);border-color:transparent}

        .gallery-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1.25rem;max-width:1200px;margin:0 auto;padding:0 1rem}
        .art-card{background:white;border-radius:10px;overflow:hidden;box-shadow:0 6px 18px rgba(43,31,23,0.06);display:flex;flex-direction:column}
        .art-card img{width:100%;height:180px;object-fit:cover;display:block}
        .art-card .meta{padding:0.85rem 1rem;color:var(--text)}
        .art-card .meta h4{margin-bottom:0.25rem;font-size:1.05rem}
        .art-card .meta p{margin:0;font-size:0.9rem;color:#6b5246}

        .card-actions{display:flex;gap:0.5rem;padding:0.75rem 1rem;border-top:1px solid rgba(0,0,0,0.04);margin-top:auto}
        .card-actions button,.card-actions a{flex:1;padding:0.55rem 0.6rem;border-radius:8px;border:2px solid var(--choco-900);background:transparent;color:var(--choco-900);font-weight:600;text-align:center;cursor:pointer;text-decoration:none}
        .card-actions .info-btn{background:var(--choco-700);color:var(--cream-200);border-color:transparent}
        .card-actions .contact-btn{background:transparent}

        @media (min-width:900px){
            .art-card img{height:180px}
        }

        /* Lightbox full-screen */
        .lightbox{position:fixed;inset:0;background:var(--cream-200);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:1.25rem;gap:1rem;opacity:0;pointer-events:none;transition:opacity 0.18s;box-sizing:border-box;overflow:hidden}
        .lightbox.open{opacity:1;pointer-events:auto}
        /* Make the image adapt to viewport while leaving room for controls
           Use viewport-relative limits to avoid overflow on small screens */
        /* Constrain image so whole lightbox (image + controls) fits the viewport without scroll */
        .lightbox img{max-width:min(90vw,1200px);max-height:calc(100vh - 220px);object-fit:contain;display:block}
        .lightbox-controls,.lightbox-meta{max-width:90vw;box-sizing:border-box}
        @media (max-height:480px){
            .lightbox img{max-height:calc(100vh - 140px)}
            .lightbox{padding:.5rem}
        }
        .lightbox-close{position:fixed;top:12px;right:12px;background:transparent;border:2px solid var(--choco-900);color:var(--choco-900);width:40px;height:40px;border-radius:50%;font-size:1.1rem;cursor:pointer;z-index:1001}
        .lightbox-meta{max-width:90%;margin-top:1rem;text-align:center;color:var(--choco-900);padding:0.5rem 1rem}
        .lightbox-meta h3{margin:0;font-size:1.2rem}
        .lightbox-meta p{margin:0.25rem 0;color:#6b5246;font-size:0.95rem}
        .lightbox-controls{max-width:90%;margin-top:1rem;text-align:center;display:none;flex-direction:column;align-items:center;gap:0.6rem}
        .lightbox-controls h3{margin:0;font-size:1.2rem;color:var(--choco-900)}
        #lb-detail p{margin:0.25rem 0;color:#6b5246;font-size:0.95rem}
        .lightbox-controls .lb-btns{display:flex;gap:0.6rem;justify-content:center;margin-top:.5rem}
        .lightbox-controls .lb-btns a{padding:.45rem .7rem;border-radius:8px;border:2px solid var(--choco-900);background:transparent;color:var(--choco-900);cursor:pointer;text-decoration:none;font-weight:600}
    </style>
</head>
<body>
    <header>
        <nav class="nav">
            <div class="logo">Galerie d'Art</div>
            <ul class="nav-list">
                <li><a href="index.html">Accueil</a></li>
                <li><a href="galerie.html">Galerie</a></li>
                <li><a href="about.html">À propos</a></li>
                <li><a href="contact.html">Contact</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section class="container">
            <h2 style="text-align:center;margin:2rem 0;color:var(--choco-900)">Nos Collections</h2>

            <div class="filters" id="filters">
                <button data-filter="all" class="active">Toutes</button>
                <button data-filter="Moderne">Moderne</button>
                <button data-filter="Classique">Classique</button>
                <button data-filter="Abstrait">Abstrait</button>
                <button data-filter="Paysage">Paysage</button>
            </div>

            <div class="gallery-grid" id="galleryGrid"></div>

            <script>
                (function(){
                    const filtersEl = document.getElementById('filters');
                    const grid = document.getElementById('galleryGrid');

                    // Ensure lightbox markup exists (image + inline controls + meta controls)
                    function ensureLightboxExists(){
                        if(document.getElementById('lightbox')) return;
                        const lb = document.createElement('div');
                        lb.id = 'lightbox';
                        lb.className = 'lightbox';
                        lb.setAttribute('aria-hidden','true');
                        lb.innerHTML = `
                            <button id="lightbox-close" class="lightbox-close" aria-label="Fermer">✕</button>
                            <img id="lightbox-img" src="" alt="" />
                            <div id="lightbox-controls" class="lightbox-controls" aria-hidden="true">
                                <div>
                                    <h3 id="lb-title-inline"></h3>
                                    <div id="lb-detail" style="margin-top:.5rem">
                                        <p id="lb-detail-artist"></p>
                                        <p id="lb-detail-creation"></p>
                                        <p id="lb-detail-collection"></p>
                                    </div>
                                    <div class="lb-btns" style="margin-top:.6rem">
                                        <a id="lb-contact-inline" class="contact-inline" href="#">Contact</a>
                                        <button id="lb-view-collection-inline" class="lb-view-collection-inline" style="padding:.45rem .7rem;border-radius:8px;border:2px solid var(--choco-900);background:transparent;color:var(--choco-900);cursor:pointer;font-weight:600;margin-left:.5rem">Voir la collection</button>
                                    </div>
                                </div>
                            </div>
                            <div class="lightbox-meta" id="lightbox-meta" aria-hidden="true">
                                <h3 id="lb-title"></h3>
                                <p id="lb-artist"></p>
                                <p id="lb-creation"></p>
                                <p id="lb-collection"></p>
                                <div style="margin-top:.6rem">
                                    <button id="lb-view-collection" style="padding:.5rem .8rem;border-radius:8px;border:2px solid var(--choco-900);background:transparent;color:var(--choco-900);cursor:pointer">Voir la collection</button>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(lb);
                    }
                    ensureLightboxExists();

                    // Format creation date as "Mois Année" in French (e.g. "décembre 2025")
                    function formatCreation(dateStr){
                        if(!dateStr) return '';
                        try{
                            const d = new Date(dateStr);
                            if(isNaN(d)) return dateStr;
                            // short month (ex: "déc.") then remove dot and capitalize first letter => "Déc 2025"
                            let s = new Intl.DateTimeFormat('fr-FR', { month: 'short', year: 'numeric' }).format(d);
                            s = s.replace(/\./g,'');
                            return s.charAt(0).toUpperCase() + s.slice(1);
                        }catch(e){
                            return dateStr;
                        }
                    }

                    // Try to load canonical data first, fallback to images/index.json
                    async function fetchImagesData(){
                        let images = [];
                        try{
                            const res = await fetch('data/images.json', {cache: 'no-store'});
                            if(res.ok) images = await res.json();
                        }catch(e){ }

                        if(!images || images.length === 0){
                            try{
                                const res2 = await fetch('images/index.json', {cache: 'no-store'});
                                if(res2.ok){
                                    const idx = await res2.json();
                                    images = idx.map(i => ({ filename: i.filename, path: i.path, title: i.filename, artist: '', creationDate: '' }));
                                }
                            }catch(e){ }
                        }
                        return images || [];
                    }

                    async function loadGallery(){
                        const images = await fetchImagesData();
                        if(!images || images.length === 0){
                            grid.innerHTML = '<p>Aucune image trouvée.</p>';
                            return;
                        }

                        // Build unique collection list
                        const collections = new Set();
                        images.forEach(img => {
                            const coll = img.collection || img.collectionName || img.data_collection || 'Sans catégorie';
                            collections.add(coll);
                        });

                        // Rebuild filter buttons
                        filtersEl.innerHTML = '';
                        const allBtn = document.createElement('button');
                        allBtn.setAttribute('data-filter','all');
                        allBtn.className = 'active';
                        allBtn.textContent = 'Toutes';
                        filtersEl.appendChild(allBtn);
                        Array.from(collections).forEach(name => {
                            const b = document.createElement('button');
                            b.setAttribute('data-filter', name);
                            b.textContent = name;
                            filtersEl.appendChild(b);
                        });

                        // Populate cards in JSON order
                        grid.innerHTML = '';
                        images.forEach(item => {
                            const collection = item.collection || item.collectionName || item.data_collection || 'Sans catégorie';
                            const title = item.title || item.filename || '';
                            const artist = item.artist || '';
                            const creation = item.creationDate || item.creation || '';
                            const src = item.path || item.url || item.src || ('images/' + item.filename || '');

                            const article = document.createElement('article');
                            article.className = 'art-card';
                            article.dataset.gallery = collection;
                            article.dataset.title = title;
                            article.dataset.artist = artist;
                            article.dataset.creation = creation;
                            article.dataset.collection = collection;

                            const img = document.createElement('img');
                            img.src = src;
                            img.alt = title;

                            const meta = document.createElement('div');
                            meta.className = 'meta';
                            const h4 = document.createElement('h4');
                            h4.textContent = title;
                            meta.appendChild(h4);
                            const p = document.createElement('p');
                            p.textContent = '';
                            meta.appendChild(p);

                            const actions = document.createElement('div');
                            actions.className = 'card-actions';
                            const infoBtn = document.createElement('button');
                            infoBtn.className = 'info-btn';
                            infoBtn.type = 'button';
                            infoBtn.textContent = "Plus d'info";
                            const contactA = document.createElement('a');
                            contactA.className = 'contact-btn';
                            contactA.href = 'contact.html?art=' + encodeURIComponent(title || '');
                            contactA.textContent = 'Contact';
                            actions.appendChild(infoBtn);
                            actions.appendChild(contactA);

                            article.appendChild(img);
                            article.appendChild(meta);
                            article.appendChild(actions);

                            grid.appendChild(article);
                        });

                        setupInteractions();
                    }

                        // Insert lightbox markup if missing (ensures script targets exist)
                        function ensureLightboxExists(){
                            if(document.getElementById('lightbox')) return;
                            const lb = document.createElement('div');
                            lb.id = 'lightbox';
                            lb.className = 'lightbox';
                            lb.setAttribute('aria-hidden','true');
                            lb.innerHTML = `
                                <button id="lightbox-close" class="lightbox-close" aria-label="Fermer">✕</button>
                                <img id="lightbox-img" src="" alt="" />
                                <div id="lightbox-controls" class="lightbox-controls" aria-hidden="true">
                                    <div>
                                        <h3 id="lb-title-inline"></h3>
                                        <div id="lb-detail" style="margin-top:.5rem">
                                            <p id="lb-detail-artist"></p>
                                            <p id="lb-detail-creation"></p>
                                            <p id="lb-detail-collection"></p>
                                        </div>
                                        <div class="lb-btns" style="margin-top:.6rem">
                                            <a id="lb-contact-inline" class="contact-inline" href="#">Contact</a>
                                        </div>
                                    </div>
                                </div>
                                <div class="lightbox-meta" id="lightbox-meta" aria-hidden="true">
                                    <h3 id="lb-title"></h3>
                                    <p id="lb-artist"></p>
                                    <p id="lb-creation"></p>
                                    <p id="lb-collection"></p>
                                    <div style="margin-top:.6rem">
                                        <button id="lb-view-collection" style="padding:.5rem .8rem;border-radius:8px;border:2px solid var(--choco-900);background:transparent;color:var(--choco-900);cursor:pointer">Voir la collection</button>
                                    </div>
                                </div>
                            `;
                            document.body.appendChild(lb);
                        }

                        ensureLightboxExists();

                    function setupInteractions(){
                        const cards = Array.from(grid.querySelectorAll('.art-card'));

                        filtersEl.addEventListener('click', (e) => {
                            if (e.target.tagName !== 'BUTTON') return;
                            const filter = e.target.getAttribute('data-filter');
                            filtersEl.querySelectorAll('button').forEach(b => b.classList.toggle('active', b === e.target));
                            cards.forEach(card => {
                                const gallery = card.getAttribute('data-gallery') || '';
                                if (filter === 'all' || gallery === filter) {
                                    card.style.display = '';
                                } else {
                                    card.style.display = 'none';
                                }
                            });
                        });

                        // Lightbox wiring
                        const lightbox = document.getElementById('lightbox');
                        const lbImg = document.getElementById('lightbox-img');
                        const lbClose = document.getElementById('lightbox-close');
                        const lbMeta = document.getElementById('lightbox-meta');
                        const lbControls = document.getElementById('lightbox-controls');
                        const lbTitleInline = document.getElementById('lb-title-inline');
                        const lbDetailArtist = document.getElementById('lb-detail-artist');
                        const lbDetailCreation = document.getElementById('lb-detail-creation');
                        const lbDetailCollection = document.getElementById('lb-detail-collection');
                        const lbContactInline = document.getElementById('lb-contact-inline');
                        const lbViewCollection = document.getElementById('lb-view-collection');
                        const lbTitle = document.getElementById('lb-title');
                        const lbArtist = document.getElementById('lb-artist');
                        const lbCreation = document.getElementById('lb-creation');
                        const lbCollection = document.getElementById('lb-collection');

                        let currentOpenCard = null;

                        function openLightbox(src, card){
                            currentOpenCard = card || null;
                            lbImg.style.display = '';
                            lbImg.src = src;
                            // Prevent page scrolling while lightbox is open
                            try{ document.body.style.overflow = 'hidden'; }catch(e){}
                            if(lbControls){ lbControls.style.display = 'flex'; lbControls.setAttribute('aria-hidden','false'); }
                            if(lbTitleInline) lbTitleInline.textContent = (card && card.dataset.title) ? card.dataset.title : '';
                            if(lbDetailArtist) lbDetailArtist.textContent = (card && card.dataset.artist) ? ('Artiste: ' + card.dataset.artist) : '';
                            if(lbDetailCreation) lbDetailCreation.textContent = (card && card.dataset.creation) ? ('Création: ' + formatCreation(card.dataset.creation)) : '';
                            if(lbDetailCollection) lbDetailCollection.textContent = (card && card.dataset.collection) ? ('Collection: ' + card.dataset.collection) : '';
                            if(lbContactInline){ const t = (card && card.dataset.title) ? card.dataset.title : ''; lbContactInline.href = 'contact.html?art=' + encodeURIComponent(t); }

                                if(card){
                                const title = card.dataset.title || '';
                                const artist = card.dataset.artist || '';
                                const creation = card.dataset.creation || '';
                                const collection = card.dataset.collection || '';
                                lbTitle.textContent = title;
                                lbArtist.textContent = artist ? ('Artiste: ' + artist) : '';
                                lbCreation.textContent = creation ? ('Création: ' + formatCreation(creation)) : '';
                                lbCollection.textContent = collection ? ('Collection: ' + collection) : '';
                                lbMeta.style.display = (title || artist || creation || collection) ? 'block' : 'none';
                                lbMeta.setAttribute('aria-hidden', lbMeta.style.display === 'none' ? 'true' : 'false');
                            }

                            lbMeta.style.display = 'none';
                            lightbox.classList.add('open');
                            lightbox.setAttribute('aria-hidden','false');
                        }

                        function openMeta(card){
                            currentOpenCard = card || null;
                            lbImg.src = '';
                            lbImg.style.display = 'none';
                            // Prevent page scrolling while lightbox is open
                            try{ document.body.style.overflow = 'hidden'; }catch(e){}
                            if(lbControls){ lbControls.style.display = 'none'; lbControls.setAttribute('aria-hidden','true'); }
                            if(card){
                                const title = card.dataset.title || '';
                                const artist = card.dataset.artist || '';
                                const creation = card.dataset.creation || '';
                                const collection = card.dataset.collection || '';
                                lbTitle.textContent = title;
                                lbArtist.textContent = artist ? ('Artiste: ' + artist) : '';
                                lbCreation.textContent = creation ? ('Création: ' + formatCreation(creation)) : '';
                                lbCollection.textContent = collection ? ('Collection: ' + collection) : '';
                                lbMeta.style.display = (title || artist || creation || collection) ? 'block' : 'none';
                                lbMeta.setAttribute('aria-hidden', lbMeta.style.display === 'none' ? 'true' : 'false');
                            }
                            lightbox.classList.add('open');
                            lightbox.setAttribute('aria-hidden','false');
                        }

                        function closeLightbox(){
                            lightbox.classList.remove('open');
                            lightbox.setAttribute('aria-hidden','true');
                            // Restore page scrolling
                            try{ document.body.style.overflow = ''; }catch(e){}
                            lbImg.src = '';
                            lbMeta.style.display = 'none';
                            lbMeta.setAttribute('aria-hidden','true');
                            lbTitle.textContent = '';
                            lbArtist.textContent = '';
                            lbCreation.textContent = '';
                            lbCollection.textContent = '';
                        }

                        cards.forEach(card=>{
                            const imgEl = card.querySelector('img');
                            if(imgEl){
                                imgEl.addEventListener('click',(e)=>{
                                    const full = card.getAttribute('data-full') || imgEl.src;
                                    if(lightbox.classList.contains('open') && document.getElementById('lightbox-img').src === full){
                                        closeLightbox();
                                    } else {
                                        openLightbox(full, card);
                                    }
                                });
                            }

                            const infoBtn = card.querySelector('.info-btn');
                            if(infoBtn){
                                infoBtn.addEventListener('click', ()=>{
                                    if(lightbox.classList.contains('open') && currentOpenCard === card){
                                        closeLightbox();
                                    } else {
                                        openMeta(card);
                                    }
                                });
                            }

                            const contactA = card.querySelector('.contact-btn');
                            if(contactA){
                                const titleEl = card.querySelector('.meta h4');
                                const title = titleEl ? titleEl.textContent.trim() : 'Tableau';
                                contactA.href = 'contact.html?art=' + encodeURIComponent(title);
                            }
                        });

                        // Wire meta 'Voir la collection' button
                        if(lbViewCollection){
                            lbViewCollection.addEventListener('click', ()=>{
                                if(!currentOpenCard) return;
                                    const collection = currentOpenCard.dataset.collection || currentOpenCard.getAttribute('data-gallery') || 'Sans catégorie';
                                closeLightbox();
                                if(collection){
                                    applyFilter(collection);
                                }
                            });
                        }
                        // Wire inline 'Voir la collection' button if present
                        const lbViewCollectionInline = document.getElementById('lb-view-collection-inline');
                        if(lbViewCollectionInline){
                            lbViewCollectionInline.addEventListener('click', ()=>{
                                if(!currentOpenCard) return;
                                const collection = currentOpenCard.dataset.collection || currentOpenCard.getAttribute('data-gallery') || 'Sans catégorie';
                                closeLightbox();
                                if(collection){
                                    applyFilter(collection);
                                }
                            });
                        }

                        function applyFilter(name){
                            const btns = filtersEl.querySelectorAll('button');
                            btns.forEach(b=> b.classList.toggle('active', b.getAttribute('data-filter') === name));
                            cards.forEach(card => {
                                const gallery = card.getAttribute('data-gallery') || '';
                                if (name === 'all' || gallery === name) {
                                    card.style.display = '';
                                } else {
                                    card.style.display = 'none';
                                }
                            });
                        }

                        lbClose.addEventListener('click', closeLightbox);
                        lbImg.addEventListener('click', closeLightbox);
                        document.addEventListener('keydown', e=>{ if(e.key === 'Escape') closeLightbox(); });
                    }

                    // Start
                    loadGallery();
                })();
            </script>
</body>
</html>
